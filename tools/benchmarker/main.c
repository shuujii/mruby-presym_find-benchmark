#include <stdio.h>
#include <stdlib.h>
#include <libgen.h>
#include <time.h>
#include <mruby.h>

#define DEFAULT_LOOP_COUNT 50000
#define WARMUP_LOOP_COUNT 50
#define SYMBOL_SIZE (sizeof(gSymbols) / sizeof(symbol_entry))

typedef struct symbol_entry {
  const char *name;
  size_t len;
} symbol_entry;

static const symbol_entry gSymbols[] = {
  {"default_proc", 12},
  {"KeyError", 8},
  {"generational_mode=", 18},
  {"tests", 5},
  {"captures", 8},
  {"**", 2},
  {"FloatDomainError", 16},
  {"SPLAT_PROC", 10},
  {"routes", 6},
  {"MTest", 5},
  {"default=", 8},
  {"<", 1},
  {"setbyte", 7},
  {"setuid?", 7},
  {"Object", 6},
  {"_proc", 5},
  {"meth=", 5},
  {"chain", 5},
  {"new", 3},
  {"__coerce_step_counter", 21},
  {"getbyte", 7},
  {"boolean_verbose_option", 22},
  {"set_backtrace", 13},
  {"key?", 4},
  {"was", 3},
  {"to_str", 6},
  {"setup", 5},
  {"ArgumentError", 13},
  {"Complex", 7},
  {"byteslice", 9},
  {"lstrip!", 7},
  {"StopIteration", 13},
  {"bin_name", 8},
  {"count", 5},
  {"hex", 3},
  {"switch", 6},
  {"erf", 3},
  {"define_method", 13},
  {"dirname", 7},
  {"private", 7},
  {"freeze", 6},
  {"each", 4},
  {"kill", 4},
  {"replace", 7},
  {"finite?", 7},
  {"AF_INET6", 8},
  {"rassoc", 6},
  {"NameError", 9},
  {"~", 1},
  {"&", 1},
  {"@license_data", 13},
  {"stopdoc", 7},
  {"!=", 2},
  {"NONE", 4},
  {"rehash", 6},
  {"ipv6_v4compat?", 14},
  {"HTTP", 4},
  {"local", 5},
  {"map", 3},
  {"TODO", 4},
  {"assert_not_equal", 16},
  {"input", 5},
  {"protected", 9},
  {"conv_arg", 8},
  {"__attached__", 12},
  {"some_header", 11},
  {"succ", 4},
  {"RangeError", 10},
  {"@middleware", 11},
  {"family_addrinfo", 15},
  {"max", 3},
  {"ancestors", 9},
  {"floor", 5},
  {"lambda", 6},
  {"reduce", 6},
  {"downcase", 8},
  {"begin", 5},
  {"each_object", 11},
  {"const_get", 9},
  {"find", 4},
  {"Arguable", 8},
  {"string_2118", 11},
  {"NotImplementedError", 19},
  {"collect!", 8},
  {"Float", 5},
  {"sub", 3},
  {"<=", 2},
  {"user", 4},
  {"last_match=", 11},
  {"MRUBY_COPYRIGHT", 15},
  {"Status", 6},
  {"@sockaddr", 9},
  {"superclass", 10},
  {"compile", 7},
  {"__outer__", 9},
  {"nan?", 4},
  {"NI_NUMERICSERV", 14},
  {"getpeereid", 10},
  {"section", 7},
  {"to_sockaddr", 11},
  {"ord", 3},
  {"REQUIRED_ARGUMENT", 17},
  {"abs", 3},
  {"@release", 8},
  {"attr", 4},
  {"connect_to", 10},
  {"LocalJumpError", 14},
  {"grep", 4},
  {"all_symbols", 11},
  {"POSIX_BRACKET_ALL_RANGE", 23},
  {"tuesday?", 8},
  {"POST", 4},
  {"frozen?", 7},
  {"include?", 8},
  {"exp", 3},
  {"coding", 6},
  {"to_proc", 7},
  {"value?", 6},
  {"verbose", 7},
  {"rewind", 6},
  {"runner=", 7},
  {"one?", 4},
  {"class_eval", 10},
  {"singleton_method", 16},
  {"last_match", 10},
  {"|", 1},
  {"group_by", 8},
  {"initialize_copy", 15},
  {"infinite?", 9},
  {"define", 6},
  {"OPTIONAL", 8},
  {"Integer", 7},
  {"unshift", 7},
  {"encoding=", 9},
  {"%", 1},
  {"store_query_hash_into_env", 25},
  {"wind_up", 7},
  {"assert_operator", 15},
  {"that", 4},
  {"has_key?", 8},
  {"entries", 7},
  {"parse_options!", 14},
  {"clean_path_info", 15},
  {"attr_reader", 11},
  {"Regexp", 6},
  {"object_413", 10},
  {"delete_at", 9},
  {"DEFAULT_MRUBY_VERSION", 21},
  {"select!", 7},
  {"svg", 3},
  {">", 1},
  {"set_banner", 10},
  {"cache", 5},
  {"reverse", 7},
  {"$asserts", 8},
  {"parse_query", 11},
  {"PI", 2},
  {"__delete", 8},
  {"compiler", 8},
  {"warn", 4},
  {"__update_hash", 13},
  {"Fixnum", 6},
  {"fail", 4},
  {"bind_call", 9},
  {"Foo", 3},
  {"include", 7},
  {"raise", 5},
  {">=", 2},
  {"MRUBY_RELEASE_NO", 16},
  {"capitalize!", 11},
  {"equal?", 6},
  {"rb", 2},
  {"blocks", 6},
  {"start", 5},
  {"__printstr__", 12},
  {"candidate", 9},
  {"extend_object", 13},
  {"set_global_variables?", 21},
  {"udp_server_recv", 15},
  {"strip!", 6},
  {"gsub!", 5},
  {"@test_dir", 9},
  {"BasicObject", 11},
  {"public", 6},
  {"@do_not_reverse_lookup", 22},
  {"bool", 4},
  {"frozen_string_literal", 21},
  {"<=>", 3},
  {"builder_data_init", 17},
  {"body=", 5},
  {"reject!", 7},
  {"Rational", 8},
  {"divmod", 6},
  {"@ISO", 4},
  {"free", 4},
  {"nonblock", 8},
  {"@dst", 4},
  {"ppid", 4},
  {"_inspect", 8},
  {"flock", 5},
  {"mesg", 4},
  {"conjugate", 9},
  {"[]=", 3},
  {"default_proc=", 13},
  {"getopts", 7},
  {"module_function", 15},
  {"name", 4},
  {"to_sym", 6},
  {"owned?", 6},
  {"message", 7},
  {"umask", 5},
  {"_pipe", 5},
  {"git_info", 8},
  {"||", 2},
  {"@github", 7},
  {"gmt?", 4},
  {"IOError", 7},
  {"+@", 2},
  {"to_f", 4},
  {"$+", 2},
  {"+", 1},
  {"split", 5},
  {"@record_separator", 17},
  {"RUBY_ENGINE", 11},
  {"@logger", 7},
  {"allocate", 8},
  {"DecimalNumeric", 14},
  {"StandardError", 13},
  {"keys", 4},
  {"ifnone", 6},
  {"capitalize", 10},
  {"level", 5},
  {"concat", 6},
  {"`", 1},
  {"short", 5},
  {"chop", 4},
  {"DirectoriesOnly", 15},
  {"merge!", 6},
  {"TrueClass", 9},
  {"nil?", 4},
  {"to_a", 4},
  {"block_given?", 12},
  {"each_byte", 9},
  {"delay=", 6},
  {"Usage", 5},
  {"message_get", 11},
  {"website", 7},
  {"$$", 2},
  {"src_h_data", 10},
  {"store", 5},
  {"first", 5},
  {"DIG", 3},
  {"attr_writer", 11},
  {"id2name", 7},
  {"parse", 5},
  {"=~", 2},
  {"@stack", 6},
  {"FLOAT_TOLERANCE", 15},
  {"swapcase", 8},
  {"Lazy", 4},
  {"pass", 4},
  {"inherited", 9},
  {"SyntaxError", 11},
  {"lstat", 5},
  {"QueryParser", 11},
  {"default", 7},
  {"popen", 5},
  {"step_ratio", 10},
  {"each_option", 11},
  {"call", 4},
  {"CFORMAT", 7},
  {"@routes", 7},
  {"backtrace", 9},
  {"RUBY_VERSION", 12},
  {"IPSocket", 8},
  {"arity", 5},
  {"args", 4},
  {"@args", 5},
  {"quo", 3},
  {"each_pair", 9},
  {"SERVER_PORT", 11},
  {"length", 6},
  {"hash", 4},
  {"extend", 6},
  {"mruby_version", 13},
  {"__to_str", 8},
  {"delay_execution_option", 22},
  {"@name", 5},
  {"spawn", 5},
  {"gethostbyname", 13},
  {"Array", 5},
  {"detect", 6},
  {"enable", 6},
  {"arity=", 6},
  {"last", 4},
  {"Class", 5},
  {"exclude_end?", 12},
  {"any?", 4},
  {"scan", 4},
  {"log10", 5},
  {"undef_method", 12},
  {"respond_to?", 11},
  {"example", 7},
  {"result", 6},
  {"RuntimeError", 12},
  {"!~", 2},
  {"skip", 4},
  {"LINK", 4},
  {"OctalInteger", 12},
  {"$`", 2},
  {"__sub_replace", 13},
  {"each_key", 8},
  {"reject", 6},
  {"-", 1},
  {"cosh", 4},
  {"step", 4},
  {"IndexError", 10},
  {"delay", 5},
  {"conditions", 10},
  {"MRUBY_DESCRIPTION", 17},
  {"$stdout", 7},
  {"@version", 8},
  {"extension", 9},
  {"result=", 7},
  {"index", 5},
  {"Generator", 9},
  {"TOTAL", 5},
  {"gmtime", 6},
  {"__ary_cmp", 9},
  {"ipv6_loopback?", 14},
  {"dup", 3},
  {"file", 4},
  {"filter_map", 10},
  {"day", 3},
  {"sort", 4},
  {"method_defined?", 15},
  {"travis_ci_data", 14},
  {"size=", 5},
  {"numerator", 9},
  {"-@", 2},
  {"@tag", 4},
  {"peek", 4},
  {"gsub", 4},
  {"ZeroDivisionError", 17},
  {"min", 3},
  {"Hash", 4},
  {"String", 6},
  {"super_method", 12},
  {"set_option", 10},
  {"Enumerable", 10},
  {"times", 5},
  {"path_not_found", 14},
  {"__upto_endless", 14},
  {"conj", 4},
  {"intern", 6},
  {"transfer", 8},
  {"assert_throws", 13},
  {"x", 1},
  {"method=", 7},
  {"rindex", 6},
  {"@__io__", 7},
  {"license=", 8},
  {"StartRecursiveDirectories", 25},
  {"__svalue", 8},
  {"!", 1},
  {"command", 7},
  {"kind_of?", 8},
  {"@value", 6},
  {"_run", 4},
  {"open", 4},
  {"loop", 4},
  {"denominator", 11},
  {"produces", 8},
  {"ScriptError", 11},
  {"TypeError", 9},
  {"author", 6},
  {"bye", 3},
  {"prepended", 9},
  {"members", 7},
  {"FileTest", 8},
  {"@errors", 7},
  {"eql?", 4},
  {"respond_to_missing?", 19},
  {"reverse!", 8},
  {"delete_prefix", 13},
  {"difference", 10},
  {"has_value?", 10},
  {"status", 6},
  {"pton", 4},
  {"Proc", 4},
  {"RUBY_ENGINE_VERSION", 19},
  {"create_mgem", 11},
  {"chomp!", 6},
  {"ArgumentStyle", 13},
  {"$;", 2},
  {"bytesize", 8},
  {"SystemStackError", 16},
  {"record_separator", 16},
  {"ceil", 4},
  {"RELEASE", 7},
  {"<<", 2},
  {"each_value", 10},
  {"step_ratio=", 11},
  {"ldexp", 5},
  {"Kernel", 6},
  {"owned_real?", 11},
  {"eof?", 4},
  {"SocketTest", 10},
  {"__classname__", 13},
  {"udp_server_loop_on", 18},
  {"catch", 5},
  {"local_address", 13},
  {"record_separator=", 17},
  {"@parser", 7},
  {"format", 6},
  {"ConstantEntry", 13},
  {"@urls", 5},
  {"disable", 7},
  {"_klass", 6},
  {"generational_mode", 17},
  {"ScriptOptions", 13},
  {"Failure", 7},
  {"class", 5},
  {"rake", 4},
  {"downto", 6},
  {"find_all", 8},
  {"FrozenError", 11},
  {"const_defined?", 14},
  {"@rake_data", 10},
  {"RegexpError", 11},
  {"@@do_not_reverse_lookup", 23},
  {"merge", 5},
  {"cover?", 6},
  {"_run_suite", 10},
  {"prepend", 7},
  {"syswrite", 8},
  {"SocketError", 11},
  {"upcase!", 7},
  {"rstrip", 6},
  {"RECV_BUF", 8},
  {"@example", 8},
  {"interval_ratio", 14},
  {"verbose=", 8},
  {"delete!", 7},
  {"inspect", 7},
  {"method_missing", 14},
  {"produce", 7},
  {"mismatch?", 9},
  {"__ary_index", 11},
  {"post", 4},
  {"values", 6},
  {"object_id", 9},
  {"global_variables", 16},
  {"extended", 8},
  {"cmp", 3},
  {"year", 4},
  {"writable_real?", 14},
  {"@root", 5},
  {"executable?", 11},
  {"prepend_features", 16},
  {"mrbtest", 7},
  {"sort!", 5},
  {"size", 4},
  {"shift", 5},
  {"bytes", 5},
  {"delete", 6},
  {"chop!", 5},
  {"usage", 5},
  {"FNM_CASEFOLD", 12},
  {"add", 3},
  {"instance_exec", 13},
  {"EntryMatch", 10},
  {"also", 4},
  {"assert_instance_of", 18},
  {"Comparable", 10},
  {"clamp", 5},
  {"initialize", 10},
  {"IO", 2},
  {"match", 5},
  {"Release", 7},
  {"alias_method", 12},
  {"NAN", 3},
  {"===", 3},
  {">>", 2},
  {"slice", 5},
  {"caller", 6},
  {"debug", 5},
  {"_gethome", 8},
  {"BINARY", 6},
  {"app", 3},
  {"js", 2},
  {"^", 1},
  {"collect", 7},
  {"@@do_not_reverse_lookup", 23},
  {"RADIX", 5},
  {"seq", 3},
  {"append_features", 15},
  {"ALT_SEPARATOR", 13},
  {"pop", 3},
  {"length=", 7},
};

static int
parse_arg(int argc, char **argv)
{
  int loop_count = 0;
  if (argc == 1) {
    loop_count = DEFAULT_LOOP_COUNT;
  } else if (argc == 2) {
    loop_count = atoi(argv[1]);
  }
  if (loop_count <= 0) {
    fprintf(stderr, "Usage: %s [LOOP_COUNT]\n", basename(argv[0]));
    loop_count = -1;
  }
  return loop_count;
}

static double
get_time()
{
  struct timespec ts;
  clock_gettime(CLOCK_MONOTONIC, &ts);
  return ts.tv_sec + ts.tv_nsec / 1e9;
}

static double
measure(mrb_state *mrb, int loop_count)
{
  double t = get_time();
  for (int n_loop = 0; n_loop < loop_count; ++n_loop) {
    for (const symbol_entry *p = gSymbols; p < gSymbols + SYMBOL_SIZE; ++p) {
      mrb_intern_check(mrb, p->name, p->len);
    }
  }
  return get_time() - t;
}

int
main(int argc, char **argv)
{
  int loop_count = parse_arg(argc, argv);
  if (loop_count < 0) return EXIT_FAILURE;
  mrb_state *mrb = mrb_open();
  if (!mrb) return EXIT_FAILURE;

  measure(mrb, WARMUP_LOOP_COUNT);
  double sec = measure(mrb, loop_count);
  double mega_times = loop_count * SYMBOL_SIZE / 1e6;
  printf("%.6fM i/s (%gM times in %.6fs)\n", mega_times / sec, mega_times, sec);

  mrb_close(mrb);
  return EXIT_SUCCESS;
}
